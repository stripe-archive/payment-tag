!function(){var e,t,n,i=function(e,t){return function(){return e.apply(t,arguments)}},r=[].slice;if(e=this.jQuery||this.Zepto,!e)throw"jQuery/Zepto required";this.PaymentTag=function(){function t(t){var n,r,a,s;null==t&&(t={}),this.changeCardType=i(this.changeCardType,this),this.formatBackNumber=i(this.formatBackNumber,this),this.formatNumber=i(this.formatNumber,this),this.restrictNumeric=i(this.restrictNumeric,this),this.restrictNumber=i(this.restrictNumber,this),this.handleToken=i(this.handleToken,this),this.submit=i(this.submit,this),this.$el=t.el||"<payment />",this.$el=e(this.$el),t.key||(t.key=this.$el.attr("key")||this.$el.attr("data-key")),null==(n=t.cvc)&&(t.cvc=!(null!=this.$el.attr("nocvc")||null!=this.$el.attr("data-nocvc"))),null==(r=t.token)&&(t.token=!(null!=this.$el.attr("notoken")||null!=this.$el.attr("data-notoken"))),null==(a=t.address)&&(t.address=null!=this.$el.attr("address")||null!=this.$el.attr("data-address")),null==(s=t.name)&&(t.name=null!=this.$el.attr("name")||null!=this.$el.attr("data-name")),t.form||(t.form=this.$el.parents("form")),this.options=e.extend({},this.defaults,t),this.options.key&&this.setKey(this.options.key),this.setForm(this.options.form),this.$el.on("keypress",".number input",this.restrictNumber),this.$el.on("keypress","input[data-numeric]",this.restrictNumeric),this.$el.on("keypress",".number input",this.formatNumber),this.$el.on("keydown",".number input",this.formatBackNumber),this.$el.on("keyup",".number input",this.changeCardType)}return t.replaceTags=function(t){var n=this;return null==t&&(t=document.body),e("payment, .payment-tag",t).each(function(e,t){return new n({el:t}).render()})},t.prototype.defaults={tokenName:"stripeToken",token:!0,cvc:!0,address:!1,name:!1},t.prototype.render=function(){return this.$el.html(this.constructor.view(this)),this.$name=this.$(".name input"),this.$number=this.$(".number input"),this.$cvc=this.$(".cvc input"),this.$expiryMonth=this.$(".expiry input.expiryMonth"),this.$expiryYear=this.$(".expiry input.expiryYear"),this.$message=this.$(".message"),this.trigger("ready"),this},t.prototype.renderToken=function(t){return this.$token=e('<input type="hidden">'),this.$token.attr("name",this.options.tokenName),this.$token.val(t),this.$el.html(this.$token)},t.prototype.setForm=function(t){return this.$form=e(t),this.$form.bind("submit.payment",this.submit)},t.prototype.setKey=function(e){return this.key=e,Stripe.setPublishableKey(this.key)},t.prototype.validate=function(){var t,n,i=this;return n=!0,this.$("input").removeClass("invalid"),this.$message.empty(),this.$("input[required]").each(function(t,r){return r=e(r),r.val()?void 0:(n=!1,i.handleError({code:"required",input:r}))}),Stripe.validateCardNumber(this.$number.val())||(n=!1,this.handleError({code:"invalid_number"})),t=this.expiryVal(),Stripe.validateExpiry(t.month,t.year)||(n=!1,this.handleError({code:"expired_card"})),this.options.cvc&&!Stripe.validateCVC(this.$cvc.val())&&(n=!1,this.handleError({code:"invalid_cvc"})),n||this.$(".invalid:input:first").select(),n},t.prototype.createToken=function(t){var n,i,r;return n=function(e,n){return n.error?t(n.error):t(null,n)},i=this.expiryVal(),r={number:this.$number.val(),cvc:this.$cvc.val()||null,exp_month:i.month,exp_year:i.year},this.options.name&&(r.name=this.$name.val()),this.options.address&&e.extend(r,this.addressVal()),Stripe.createToken(r,n)},t.prototype.submit=function(e){return null!=e&&e.preventDefault(),null!=e&&e.stopImmediatePropagation(),this.validate()&&!this.pending?(this.pending=!0,this.disableInputs(),this.trigger("pending"),this.$el.addClass("pending"),this.createToken(this.handleToken)):void 0},t.prototype.handleToken=function(e,t){return this.enableInputs(),this.trigger("complete"),this.$el.removeClass("pending"),this.pending=!1,e?this.handleError(e):(this.trigger("success",t),this.$el.addClass("success"),this.options.token&&this.renderToken(t.id),this.$form.unbind("submit.payment",this.submit),this.$form.submit())},t.prototype.restrictNumber=function(e){var t,n,i;return t=String.fromCharCode(e.which),!/^\d+$/.test(t)||null!=this.$number.prop("selectionStart")&&this.$number.prop("selectionStart")!==this.$number.prop("selectionEnd")||(null!=(i=document.selection)?"function"==typeof i.createRange?i.createRange().text:void 0:void 0)?void 0:(n=this.$number.val()+t,n=n.replace(/\D/g,""),"American Express"===Stripe.cardType(n)?n.length<=15:n.length<=16)},t.prototype.restrictNumeric=function(e){var t;return e.metaKey?!0:32===e.which?!1:0===e.which?!0:e.which<33?!0:(t=String.fromCharCode(e.which),!!/[\d\s]/.test(t))},t.prototype.formatNumber=function(e){var t,n,i,r,a;if(t=String.fromCharCode(e.which),/^\d+$/.test(t)){if(a=this.$number.val(),r=Stripe.cardType(a+t),n=(a.replace(/\D/g,"")+t).length,"American Express"===r){if(n>=15)return}else if(n>=16)return;if(null==this.$number.prop("selectionStart")||this.$number.prop("selectionStart")===a.length)return i="American Express"===r?/^(\d{4}|\d{4}\s\d{6})$/:/(?:^|\s)(\d{4})$/,i.test(a)?(e.preventDefault(),this.$number.val(a+" "+t)):i.test(a+t)?(e.preventDefault(),this.$number.val(a+t+" ")):void 0}},t.prototype.formatBackNumber=function(e){var t;return t=this.$number.val(),e.meta?void 0:8===e.which&&/\s\d?$/.test(t)?(e.preventDefault(),this.$number.val(t.replace(/\s\d?$/,""))):void 0},t.prototype.cardTypes={Visa:"visa","American Express":"amex",MasterCard:"mastercard",Discover:"discover",Unknown:"unknown"},t.prototype.changeCardType=function(){var e,t,n,i;if(n=Stripe.cardType(this.$number.val()),!this.$number.hasClass(n)){i=this.cardTypes;for(t in i)e=i[t],this.$number.removeClass(e);return this.$number.addClass(this.cardTypes[n])}},t.prototype.handleError=function(e){switch(e.message&&this.$message.text(e.message),e.code){case"required":this.invalidInput(e.input);break;case"card_declined":this.invalidInput(this.$number);break;case"invalid_number":case"incorrect_number":this.invalidInput(this.$number);break;case"invalid_expiry_month":this.invalidInput(this.$expiryMonth);break;case"invalid_expiry_year":case"expired_card":this.invalidInput(this.$expiryYear);break;case"invalid_cvc":this.invalidInput(this.$cvc)}return this.trigger("error",e),"undefined"!=typeof console&&null!==console?console.error("Stripe error:",e):void 0},t.prototype.invalidInput=function(e){return e.addClass("invalid"),this.trigger("invalid",[e.attr("name"),e])},t.prototype.expiryVal=function(){var e,t,n,i;return n=function(e){return e.replace(/^\s+|\s+$/g,"")},e=n(this.$expiryMonth.val()),i=n(this.$expiryYear.val()),2===i.length&&(t=(new Date).getFullYear(),t=t.toString().slice(0,2),i=t+i),{month:e,year:i}},t.prototype.addressVal=function(){var t;return t={},this.$(".address input").each(function(n,i){return t[i.name]=e(this).val()}),t},t.prototype.enableInputs=function(){var t;return t=this.$el.add(this.$form).find(":input"),t.each(function(){var n,i;return n=e(this),t.attr("disabled",null!=(i=n.data("olddisabled"))?i:!1)})},t.prototype.disableInputs=function(){var t;return t=this.$el.add(this.$form).find(":input"),t.each(function(){var t;return t=e(this),t.data("olddisabled",t.attr("disabled")),t.attr("disabled",!0)})},t.prototype.trigger=function(){var e,t,n;return t=arguments[0],e=2<=arguments.length?r.call(arguments,1):[],(n=this.$el).trigger.apply(n,[""+t+".payment"].concat(r.call(e)))},t.prototype.$=function(t){return e(t,this.$el)},t}(),document.createElement("payment"),"undefined"!=typeof module&&null!==module&&(module.exports=PaymentTag),t=this,t.Stripe?e(function(){return"function"==typeof PaymentTag.replaceTags?PaymentTag.replaceTags():void 0}):(n=document.createElement("script"),n.onload=n.onreadystatechange=function(){return t.Stripe&&!n.done?(n.done=!0,"function"==typeof PaymentTag.replaceTags?PaymentTag.replaceTags():void 0):void 0},n.src="https://js.stripe.com/v1/",e(function(){var e;return e=document.getElementsByTagName("script")[0],null!=e?e.parentNode.insertBefore(n,e):void 0}))}.call(this),function(){this.PaymentTag||(this.PaymentTag={}),this.PaymentTag.view=function(e){e||(e={});var t,n=[],i=e.safe,r=e.escape;return t=e.safe=function(e){if(e&&e.ecoSafe)return e;("undefined"==typeof e||null==e)&&(e="");var t=new String(e);return t.ecoSafe=!0,t},r||(r=e.escape=function(e){return(""+e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}),function(){!function(){this.options.address&&n.push('\n  <div class="address">\n    <label for="paymentName">Name</label>\n    <input name="name" type="text" id="paymentName" x-autocompletetype="name" autocapitalize="words" required>\n\n    <label for="paymentAddressLine1">Address</label>\n    <input name="address_line1" type="text" id="paymentAddressLine1" x-autocompletetype="address-line1" required>\n    <input name="address_line2" type="text" id="paymentAddressLine2" x-autocompletetype="address-line2">\n\n    <label for="paymentAddressCity">City</label>\n    <input name="address_city" type="text" id="paymentAddressCity" x-autocompletetype="city" required>\n\n    <div class="clear">\n      <div class="state">\n        <label for="paymentAddressState">State</label>\n        <input name="address_state" type="text" id="paymentAddressState" x-autocompletetype="state" required>\n      </div>\n\n      <div class="zip">\n        <label for="paymentAddressZip">Zip / Postcode</label>\n        <input name="address_zip" type="text" id="paymentAddressZip" x-autocompletetype="postal-code" required>\n      </div>\n    </div>\n  </div>\n'),n.push('\n\n<div class="message"></div>\n\n'),this.options.name&&!this.options.address&&n.push('\n  <div class="name">\n    <label for="paymentName">Name</label>\n\n    <input type="text" id="paymentName" x-autocompletetype="name" autocapitalize="words" required>\n  </div>\n'),n.push('\n\n<div class="number">\n  <label for="paymentNumber">Card number</label>\n\n  <input type="text" id="paymentNumber" pattern="[\\d| ]*"  placeholder="&#x25CF;&#x25CF;&#x25CF;&#x25CF; &#x25CF;&#x25CF;&#x25CF;&#x25CF; &#x25CF;&#x25CF;&#x25CF;&#x25CF; &#x25CF;&#x25CF;&#x25CF;&#x25CF;" x-autocompletetype="cc-number" required data-numeric>\n</div>\n\n<div class="expiry">\n  <label for="paymentExpiryMonth">Expires<em> (mm/yy)</em></label>\n\n  <input class="expiryMonth" type="text" id="paymentExpiryMonth" pattern="\\d*" x-autocompletetype="cc-exp-month" placeholder="mm" maxlength="2" data-numeric required>\n  <input class="expiryYear" type="text" id="paymentExpiryYear" pattern="\\d*" x-autocompletetype="cc-exp-year" placeholder="yy" maxlength="4" data-numeric required>\n</div>\n\n'),this.options.cvc&&n.push('\n  <div class="cvc">\n    <label for="paymentCVC">Security code</label>\n    <input type="text" id="paymentCVC" placeholder="CVC" pattern="\\d*" x-autocompletetype="cc-csc" maxlength="4" data-numeric required>\n  </div>\n'),n.push("\n")}.call(this)}.call(e),e.safe=i,e.escape=r,n.join("")}}.call(this);